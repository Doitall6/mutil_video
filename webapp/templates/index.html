<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多摄像头目标人物追踪</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { background-color: #f8fafc; color: #1e293b; }
        .video-panel { background-color: #ffffff; border-radius: 0.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .video-frame { width: 100%; height: 100%; object-fit: contain; display: none; }
        .video-placeholder { height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem; color: #94a3b8; background: #f1f5f9; }
        .status-badge { padding: 0.15rem 0.5rem; border-radius: 999px; font-size: 0.7rem; }
        .status-idle { background: #e2e8f0; color: #64748b; }
        .status-live { background: #dcfce7; color: #16a34a; }
        input#showAll:checked + span { background-color: #22c55e; }
        input#showAll:checked + span .dot { transform: translateX(16px); }
        .dot { transition: transform 0.2s ease; }
        
        /* 折叠面板样式 */
        .collapse-section { border: 1px solid #e2e8f0; border-radius: 0.5rem; background: #ffffff; }
        .collapse-header { 
            cursor: pointer; 
            padding: 0.5rem 0.75rem; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            user-select: none;
        }
        .collapse-header:hover { background: #f8fafc; }
        .collapse-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.25s ease-out, padding 0.25s ease-out;
            padding: 0 0.75rem;
        }
        .collapse-content.open { 
            max-height: 500px; 
            padding: 0.5rem 0.75rem 0.75rem;
        }
        .collapse-icon { transition: transform 0.25s ease; }
        .collapse-icon.open { transform: rotate(180deg); }
        
        /* 紧凑滑块 */
        input[type="range"] { height: 4px; accent-color: #3b82f6; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        /* 输入框亮色样式 */
        .input-light { background: #f8fafc; border: 1px solid #e2e8f0; color: #1e293b; }
        .input-light:focus { outline: none; border-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col">
    <!-- 顶部栏 -->
    <header class="flex-shrink-0 flex items-center justify-between px-4 py-2 border-b border-slate-200 bg-white shadow-sm">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-bold text-slate-800">多摄像头目标人物追踪</h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="modelIndicator" class="status-badge status-idle">模型未加载</div>
            <button id="initBtn" onclick="initializeModels()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-semibold">初始化模型</button>
            <button id="startBtn" onclick="startProcessing()" class="px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white rounded text-xs font-semibold">开始检测</button>
            <button id="stopBtn" onclick="stopProcessing()" class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded text-xs font-semibold hidden">停止检测</button>
        </div>
    </header>

    <!-- 主内容区 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧控制面板 -->
        <aside class="w-72 flex-shrink-0 border-r border-slate-200 bg-slate-50 overflow-y-auto p-2 space-y-2">
            
            <!-- 检测参数 - 可折叠 -->
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse(this)">
                    <span class="text-sm font-semibold flex items-center gap-2 text-slate-700"><i class="fa-solid fa-sliders text-xs text-slate-400"></i> 检测参数</span>
                    <i class="fa-solid fa-chevron-down collapse-icon text-xs text-slate-400"></i>
                </div>
                <div class="collapse-content">
                    <div class="space-y-2 text-xs">
                        <div class="flex items-center gap-2">
                            <label class="w-16 text-slate-500">置信度</label>
                            <input id="confThres" type="range" min="0.1" max="0.9" step="0.05" value="0.5" class="flex-1" oninput="document.getElementById('confVal').textContent=this.value">
                            <span id="confVal" class="font-mono w-8 text-right text-slate-600">0.5</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="w-16 text-slate-500">NMS</label>
                            <input id="nmsThres" type="range" min="0.1" max="0.9" step="0.05" value="0.4" class="flex-1" oninput="document.getElementById('nmsVal').textContent=this.value">
                            <span id="nmsVal" class="font-mono w-8 text-right text-slate-600">0.4</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="w-16 text-slate-500">ReID阈值</label>
                            <input id="distThres" type="range" min="0.3" max="0.9" step="0.05" value="0.7" class="flex-1" oninput="document.getElementById('distVal').textContent=this.value">
                            <span id="distVal" class="font-mono w-8 text-right text-slate-600">0.7</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="w-16 text-slate-500">最小尺寸</label>
                            <input id="boxSize" type="range" min="20" max="150" step="5" value="40" class="flex-1" oninput="document.getElementById('boxVal').textContent=this.value">
                            <span id="boxVal" class="font-mono w-8 text-right text-slate-600">40</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="w-16 text-slate-500">轨迹长度</label>
                            <input id="trailLen" type="range" min="10" max="100" step="5" value="50" class="flex-1" oninput="document.getElementById('trailVal').textContent=this.value">
                            <span id="trailVal" class="font-mono w-8 text-right text-slate-600">50</span>
                        </div>
                        <div class="flex items-center justify-between pt-1">
                            <span class="text-slate-500">显示所有检测</span>
                            <label class="inline-flex items-center cursor-pointer">
                                <input id="showAll" type="checkbox" class="sr-only" checked>
                                <span class="w-8 h-4 bg-slate-300 rounded-full relative transition">
                                    <span class="dot absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full shadow"></span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 目标人物 - 可折叠 -->
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse(this)">
                    <span class="text-sm font-semibold flex items-center gap-2 text-slate-700"><i class="fa-solid fa-user text-xs text-slate-400"></i> 目标人物 <span id="queryCount" class="text-slate-400 font-normal">(0)</span></span>
                    <i class="fa-solid fa-chevron-down collapse-icon text-xs text-slate-400"></i>
                </div>
                <div class="collapse-content">
                    <div class="space-y-2 text-xs">
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-slate-500">宽</label>
                                <input id="resizeWidth" type="number" value="128" class="w-full input-light rounded px-2 py-1">
                            </div>
                            <div class="flex-1">
                                <label class="text-slate-500">高</label>
                                <input id="resizeHeight" type="number" value="256" class="w-full input-light rounded px-2 py-1">
                            </div>
                            <button onclick="loadDefaultQueries()" class="self-end px-2 py-1 text-blue-600 hover:bg-blue-50 rounded" title="加载默认">默认</button>
                        </div>
                        <div class="border border-dashed border-slate-300 rounded p-2 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50" onclick="document.getElementById('queryUpload').click()">
                            <input id="queryUpload" type="file" accept="image/*" class="hidden" onchange="uploadQuery(event)">
                            <span class="text-slate-500"><i class="fa-solid fa-plus mr-1"></i>上传目标图片</span>
                        </div>
                        <div id="queryList" class="grid grid-cols-4 gap-1 max-h-20 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- 视频源 - 默认展开 -->
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse(this)">
                    <span class="text-sm font-semibold flex items-center gap-2 text-slate-700"><i class="fa-solid fa-video text-xs text-slate-400"></i> 视频源</span>
                    <i class="fa-solid fa-chevron-down collapse-icon open text-xs text-slate-400"></i>
                </div>
                <div class="collapse-content open">
                    <div class="space-y-2 text-xs">
                        <!-- 上传视频 -->
                        <button class="w-full py-1.5 border border-slate-300 rounded hover:bg-slate-100 flex items-center justify-center gap-2 text-slate-600" onclick="document.getElementById('videoUpload').click()">
                            <i class="fa-solid fa-upload"></i>上传视频文件 (可多选)
                        </button>
                        <input id="videoUpload" type="file" accept="video/*" multiple class="hidden" onchange="uploadVideos(event)">
                        
                        <!-- 摄像头绑定 - 折叠子面板 -->
                        <details class="border border-slate-200 rounded bg-slate-50">
                            <summary class="px-2 py-1.5 cursor-pointer hover:bg-slate-100 flex items-center justify-between text-slate-600">
                                <span><i class="fa-solid fa-camera mr-2 text-slate-400"></i>绑定摄像头</span>
                            </summary>
                            <div class="p-2 space-y-2 border-t border-slate-200 bg-white">
                                <div class="flex gap-1">
                                    <select id="cameraSelect" class="flex-1 input-light rounded px-2 py-1">
                                        <option value="" disabled selected>选择...</option>
                                    </select>
                                    <button class="px-2 py-1 text-slate-400 hover:text-slate-600" onclick="refreshCameras()" title="刷新"><i class="fa-solid fa-sync"></i></button>
                                    <button class="px-2 py-1 bg-green-600 hover:bg-green-500 text-white rounded" onclick="assignCamera()">绑定</button>
                                </div>
                                <input id="cameraCustom" type="text" placeholder="自定义 URI / GStreamer" class="w-full input-light rounded px-2 py-1">
                                <input id="cameraLabel" type="text" placeholder="显示名称 (可选)" class="w-full input-light rounded px-2 py-1">
                            </div>
                        </details>
                        
                        <!-- 已分配通道 -->
                        <div id="videoList" class="space-y-1 max-h-24 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 右侧视频网格 -->
        <main class="flex-1 p-2 overflow-hidden bg-slate-100">
            <template id="videoPanelTemplate">
                <div class="video-panel p-2 flex flex-col h-full">
                    <div class="flex justify-between items-center text-xs mb-1">
                        <span class="panel-title text-slate-600"></span>
                        <div class="flex items-center gap-2">
                            <span class="status-badge status-idle panel-status">等待</span>
                            <button class="text-slate-400 hover:text-red-500" title="清除" onclick="clearVideoSlot(EVENT_SLOT)"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 relative">
                        <div class="video-placeholder" id="placeholder-EVENT_SLOT">
                            <i class="fa-solid fa-video-slash text-2xl"></i>
                            <span class="text-xs">无信号</span>
                        </div>
                        <img class="video-frame absolute inset-0" id="videoFrame-EVENT_SLOT" alt="通道视频">
                    </div>
                </div>
            </template>
            <div id="videoGrid" class="grid grid-cols-2 gap-2 h-full"></div>
        </main>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
